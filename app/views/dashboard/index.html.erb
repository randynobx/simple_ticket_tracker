<h2>Dashboard</h2>
<div>
    <h3>Finances</h3>
    <table>
        <tr><td>Gross Income:</td><td><%= number_to_currency(Record.sum(:income)) %></td></tr>
        <tr><td>Expenses:</td><td><%= number_to_currency(Record.sum(:expense)) %></td></tr>
        <tr><td>Outstanding balance:</td><td><%= number_to_currency(Record.where(settled: false).sum(:total)) %></td></tr>
        <tr><td>Total balance:</td><td><%= number_to_currency(Record.sum(:total)) %></td></tr>
    </table>
</div>

<div>
    <h3>Accounts</h3>
    <table>
        <% @top_ticket = Account.find_by(id: Ticket.group(:account_id).count.max{|a, b| a.last <=> b.last}.first) %>
        <% @top_revenue = Account.find_by(id: Record.group(:account_id).sum(:total).max.first) %>
        <tr><td>Top Client (Tickets):</td><td><%= link_to @top_ticket.name, account_path(@top_ticket.id) %></td></tr>
        <tr><td>Top Client (Revenue:</td><td><%= link_to @top_revenue.name, account_path(@top_revenue.id) %></td></tr>
    </table>
</div>

<hr>

<div>
    <h3>Unsettled records</h3>
    <table>
      <tr><td>Total outstanding balance (income):</td><td><%= number_to_currency(Record.where(settled: false).sum(:income)) %></td></tr>
      <tr><td>Total outstanding balance (expense):</td><td><%= number_to_currency(Record.where(settled: false).sum(:expense)) %></td></tr>
      <tr><td>Net outstanding balance:</td><td><%= number_to_currency(Record.where(settled:false).sum(:total)) %></td></tr>
    </table>

    <table>
      <tr>
        <th>ID</th>
        <th>Date</th>
        <th>Account</th>
        <th>Ticket</th>
        <th>Income</th>
        <th>Expense</th>
        <th>Balance</th>
        <th>Settled</th>
        <th>Show</th>
        <th>Edit</th>
      </tr>

      <% Record.where(settled: false).each do |record| %>
        <tr>
          <td><%= record.id %></td>
          <td><%= record.date %></td>
          <td><%= link_to Account.find(record.account_id).name, account_path(Account.find(record.account_id)) %></td>
          <td><%= link_to record.ticket_id, ticket_path(record.ticket_id) %></td>
          <td><%= number_to_currency(record.income) %></td>
          <td><%= number_to_currency(record.expense) %></td>
          <td><%= number_to_currency(record.total) %></td>
          <td><%= record.settled %></td>
          <td><%= link_to 'Show', record_path(record) %></td>
          <td><%= link_to 'Edit', edit_record_path(record) %></td>
        </tr>
      <% end %>
    </table>
</div>

<hr>

<div>
    <h3>Open tickets</h3>
    <p>Total outstanding balance: <%= number_to_currency(Ticket.where(closed: false).sum(:total)) %></p>

    <table>
      <tr>
        <th>ID</th>
        <th>Date</th>
        <th>Account</th>
        <th>Service</th>
        <th>Materials Cost</th>
        <th>Labor</th>
        <th>Total</th>
        <th>Records</th>
        <th>Show</th>
        <th>Edit</th>
      </tr>
    
      <% Ticket.where(closed: false).each do |ticket| %>
        <tr>
          <td><%= ticket.id %></td>
          <td><%= ticket.date %></td>
          <td><%= link_to Account.find(ticket.account_id).name, account_path(Account.find(ticket.account_id)) %></td>
          <td><%= link_to Service.find(ticket.service_id).category, service_path(Service.find(ticket.service_id)) %></td>
          <td><%= number_to_currency(ticket.materialscost) %></td>
          <td><%= number_to_currency(ticket.labor) %></td>
          <td><%= number_to_currency(ticket.total) %></td>
          <td><%= Record.where(ticket_id: ticket.id).count %></td>
          <td><%= link_to 'Show', ticket_path(ticket) %></td>
          <td><%= link_to 'Edit', edit_ticket_path(ticket) %></td>
        </tr>
        </tr>
      <% end %>
    </table>
</div>